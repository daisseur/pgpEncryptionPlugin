# Advanced Configuration

## Project Overview

**PGP Encryption Plugin** is a Vencord plugin that adds end-to-end encryption to Discord messages using OpenPGP standards. It supports multiple encryption algorithms (RSA, ECC/ECDSA), automatic encryption/decryption, and per-user key management.

**Key Features:**
- Multiple key algorithms (RSA 2048/4096, Curve25519, P-256/384/521, secp256k1, Brainpool curves)
- Base64 encoding option for compact encrypted messages
- Automatic encryption/decryption for configured conversations
- Per-user key configuration via context menu
- Built-in key generator with multiple curve options

## Manual Key Export/Import

Backup or transfer your keys manually using the developer console.

### Export All Keys

```javascript
// Open console (Ctrl+Shift+I)
const keys = Vencord.Plugins.plugins["PGP Encryption"].getAllKeys();
console.log(JSON.stringify(keys, null, 2));
// Copy the result and save it in a secure file
```

### Import Keys

```javascript
// Open console (Ctrl+Shift+I)
const keysToImport = {
    "USER_ID_1": {
        "publicKey": "-----BEGIN PGP PUBLIC KEY BLOCK-----\n...",
        "privateKey": "-----BEGIN PGP PRIVATE KEY BLOCK-----\n..."
    }
};

Object.entries(keysToImport).forEach(([userId, keys]) => {
    Vencord.Plugins.plugins["PGP Encryption"].setUserKeys(userId, keys);
});
```

## Programmatic Usage

### Manually Encrypt a Message

```javascript
const encrypted = await Vencord.Plugins.plugins["PGP Encryption"].encryptMessage(
    "My secret message",
    publicKeyString
);
console.log(encrypted);
```

### Manually Decrypt a Message

```javascript
const decrypted = await Vencord.Plugins.plugins["PGP Encryption"].decryptMessage(
    encryptedMessage,
    privateKeyString
);
console.log(decrypted);
```

## Command-line Key Generation

Generate keys using GPG (GnuPG):

```bash
# Generate a key pair
gpg --full-generate-key
# Choose: RSA, 4096 bits, no expiration

# Export public key
gpg --armor --export your.email@example.com > public-key.asc

# Export private key (KEEP IT SECURE!)
gpg --armor --export-secret-keys your.email@example.com > private-key.asc
```

Then copy the contents of these files into the plugin interface.

## Storage Structure

Keys are stored in Vencord's DataStore under the key `pgp-encryption-keys`:

```json
{
  "123456789": {
    "publicKey": "-----BEGIN PGP PUBLIC KEY BLOCK-----\n...",
    "privateKey": "-----BEGIN PGP PRIVATE KEY BLOCK-----\n..."
  },
  "987654321": {
    "publicKey": "-----BEGIN PGP PUBLIC KEY BLOCK-----\n...",
    "privateKey": ""
  }
}
```

## Complete Cleanup

To remove all stored keys:

```javascript
// ⚠️ WARNING: This action is irreversible!
Vencord.Plugins.plugins["PGP Encryption"].clearAllKeys();
```

## Debugging

### Enable Detailed Logs

Enable debug logging in plugin settings or watch console errors:

```javascript
// Encryption/decryption errors appear in console
// with prefix "PGP decryption error:" or "PGP encryption error:"
```

### Check Stored Keys

```javascript
const storage = Vencord.Plugins.plugins["PGP Encryption"];
const keys = storage.getAllKeys();
console.table(Object.entries(keys).map(([userId, k]) => ({
    userId,
    hasPublicKey: !!k.publicKey,
    hasPrivateKey: !!k.privateKey
})));
```

## Integration with Other Tools

### Compatibility

This plugin uses standard PGP format, so you can:
- Use keys generated by GPG, Kleopatra, or any other PGP tool
- Exchange messages with users using other PGP clients
- Import/export your keys to other applications

### Supported Formats

- ✅ RSA 2048, 4096 bits
- ✅ ECC/ECDSA (Curve25519, P-256/384/521, secp256k1, Brainpool curves)
- ✅ ASCII armored format (`-----BEGIN PGP...`)
- ✅ Base64 encoded messages (automatic decode)
- ❌ Passphrase-protected keys (not currently supported)

## Advanced Security

### Recommendations

1. **Key Rotation**: Generate new keys every 1-2 years
2. **Separate Keys**: Use different keys for each important contact
3. **Backup**: Export and save your keys in a password vault
4. **Verification**: Verify key fingerprints with your contact out-of-band

### Get Key Fingerprint

```javascript
const key = await openpgp.readKey({ armoredKey: publicKeyString });
console.log(key.getFingerprint());
```

## Performance

### Optimizations

The plugin uses:
- `findByPropsLazy` for on-demand webpack module loading
- Asynchronous decryption to avoid blocking the UI
- In-memory key caching

### Limitations

- RSA 4096 encryption/decryption can take ~100-500ms
- Very long messages may slightly slow down sending
- Key generation takes 2-5 seconds (faster with ECC curves)

## Plugin API (for Developers)

Extend this plugin or create integrations:

```typescript
interface PGPEncryptionAPI {
    // Encrypt a message
    encryptMessage(text: string, publicKey: string): Promise<string>;
    
    // Decrypt a message
    decryptMessage(encryptedText: string, privateKey: string): Promise<string>;
    
    // Storage management
    getUserKeys(userId: string): PGPKeys | null;
    setUserKeys(userId: string, keys: PGPKeys): void;
    getAllKeys(): Record<string, PGPKeys>;
    clearAllKeys(): void;
}
```

## Advanced Troubleshooting

### Plugin Won't Load

```bash
# Check build errors
cd /path/to/Vencord
pnpm build --watch

# Check Discord console for errors
```

### Patches Not Applying

```javascript
// Check active patches
Vencord.Webpack.patches
    .filter(p => p.plugin === "PGP Encryption")
    .forEach(p => console.log(p));
```

### Reset Plugin

```javascript
// Disable
Vencord.Plugins.plugins["PGP Encryption"].stop();

// Clear data
Vencord.Plugins.plugins["PGP Encryption"].clearAllKeys();

// Re-enable
Vencord.Plugins.plugins["PGP Encryption"].start();
```

## Technical Details

### Base64 Encoding

When **"Encode encrypted messages in base64"** is enabled:
- Outgoing: PGP armored message → base64 encoded
- Incoming: Automatically detects and decodes base64 → decrypts PGP
- Benefits: More compact, single-line messages

### Key Types Comparison

| Algorithm | Key Size | Speed | Security | Recommendation |
|-----------|----------|-------|----------|----------------|
| RSA 2048 | Large | Medium | Good | Quick testing |
| RSA 4096 | Very Large | Slow | Very Good | Standard choice |
| Curve25519 | Small | Very Fast | Excellent | **Best overall** |
| P-256 | Small | Fast | Good | NIST standard |
| P-521 | Small | Fast | Excellent | High security |
| secp256k1 | Small | Fast | Good | Crypto compatibility |

---

For advanced questions, consult:
- [openpgp.js Documentation](https://openpgpjs.org/)
- [Plugin Source Code](index.tsx)
- [Vencord API Docs](https://github.com/Vendicated/Vencord/tree/main/docs)
